<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Epstein Financial Shell Network — Full Architecture</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Instrument+Serif&family=JetBrains+Mono:wght@300;400;500;600&family=Outfit:wght@200;300;400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #07080a;
    color: #b0b0bc;
    font-family: 'JetBrains Mono', monospace;
    overflow: hidden;
    height: 100vh;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
  }

  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    padding: 20px 32px 14px;
    background: linear-gradient(to bottom, rgba(7,8,10,0.95) 60%, transparent);
    pointer-events: none;
  }

  .header h1 {
    font-family: 'Instrument Serif', serif;
    font-size: 28px;
    font-weight: 400;
    color: #e0e0e8;
    letter-spacing: -0.5px;
  }

  .header .meta {
    font-size: 10px;
    color: #555566;
    margin-top: 4px;
    letter-spacing: 0.5px;
  }

  .header .meta em { color: #8888a0; font-style: normal; }

  .toolbar {
    position: fixed;
    top: 80px;
    left: 32px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .toolbar button {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    color: #666678;
    padding: 7px 14px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    font-weight: 400;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.25s;
    text-align: left;
    border-radius: 2px;
    pointer-events: all;
  }

  .toolbar button:hover { background: rgba(255,255,255,0.06); color: #9999aa; }

  .toolbar button.active {
    background: rgba(255,255,255,0.06);
    border-color: rgba(200,160,100,0.25);
    color: #c8a064;
  }

  .toolbar .divider {
    height: 1px;
    background: rgba(255,255,255,0.04);
    margin: 6px 0;
  }

  .legend {
    position: fixed;
    bottom: 24px;
    left: 32px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 9px;
    color: #555566;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .legend-line {
    width: 20px;
    height: 0;
    flex-shrink: 0;
  }

  #canvas { width: 100vw; height: 100vh; }

  /* Detail panel */
  .panel {
    position: fixed;
    right: -480px;
    top: 0;
    width: 480px;
    height: 100vh;
    background: rgba(10,11,14,0.97);
    border-left: 1px solid rgba(255,255,255,0.05);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    z-index: 20;
    transition: right 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    overflow-y: auto;
    padding: 0;
  }

  .panel.open { right: 0; }

  .panel-head {
    padding: 28px 28px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    position: relative;
  }

  .panel-head .close {
    position: absolute;
    right: 20px;
    top: 20px;
    background: none;
    border: none;
    color: #555566;
    font-size: 16px;
    cursor: pointer;
    padding: 4px 8px;
  }

  .panel-head h2 {
    font-family: 'Outfit', sans-serif;
    font-size: 18px;
    font-weight: 500;
    color: #e0e0e8;
    padding-right: 40px;
  }

  .panel-head .badge {
    display: inline-block;
    font-size: 8px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 3px 10px;
    border-radius: 2px;
    margin-top: 8px;
    font-family: 'JetBrains Mono', monospace;
  }

  .panel-stats {
    padding: 16px 28px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .stat-card {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.04);
    padding: 12px 14px;
    border-radius: 3px;
  }

  .stat-card .stat-val {
    font-family: 'Outfit', sans-serif;
    font-size: 20px;
    font-weight: 600;
    color: #e0e0e8;
  }

  .stat-card .stat-label {
    font-size: 9px;
    color: #555566;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }

  .panel-section {
    padding: 16px 28px;
    border-top: 1px solid rgba(255,255,255,0.03);
  }

  .panel-section h3 {
    font-family: 'Outfit', sans-serif;
    font-size: 10px;
    font-weight: 500;
    color: #666678;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .conn-item {
    display: flex;
    align-items: center;
    padding: 7px 0;
    border-bottom: 1px solid rgba(255,255,255,0.02);
    gap: 10px;
  }

  .conn-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .conn-name {
    flex: 1;
    font-size: 11px;
    color: #9999aa;
  }

  .conn-val {
    font-size: 10px;
    color: #c8a064;
    font-weight: 500;
    text-align: right;
  }

  .conn-bar {
    width: 60px;
    height: 3px;
    background: rgba(255,255,255,0.04);
    border-radius: 1px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .conn-bar-fill {
    height: 100%;
    border-radius: 1px;
    transition: width 0.3s;
  }

  /* tooltip */
  .tip {
    position: fixed;
    background: rgba(14,15,20,0.95);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 10px 14px;
    font-size: 10px;
    color: #b0b0bc;
    pointer-events: none;
    z-index: 30;
    display: none;
    max-width: 300px;
    line-height: 1.6;
    backdrop-filter: blur(10px);
  }

  .tip strong {
    font-family: 'Outfit', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: #e0e0e8;
    display: block;
    margin-bottom: 2px;
  }

  .search-box {
    position: fixed;
    top: 80px;
    right: 32px;
    z-index: 10;
  }

  .search-box input {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    color: #b0b0bc;
    padding: 7px 14px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    width: 200px;
    outline: none;
    border-radius: 2px;
    transition: border-color 0.2s;
  }

  .search-box input:focus {
    border-color: rgba(200,160,100,0.3);
  }

  .search-box input::placeholder { color: #444455; }

  .instructions {
    position: fixed;
    bottom: 24px;
    right: 32px;
    font-size: 9px;
    color: #333344;
    text-align: right;
    line-height: 1.8;
    z-index: 10;
  }
</style>
</head>
<body>

<div class="header">
  <h1>Epstein Financial Shell Network</h1>
  <div class="meta">
    <em>14 shell entities</em> · <em>8+ banking institutions</em> · <em>178,592 money references</em> · <em>1.48M documents</em><br>
    DOJ EFTA Document Release — Corpus-Wide Analysis
  </div>
</div>

<div class="toolbar" id="toolbar">
  <button class="active" onclick="setView('all')">All connections</button>
  <button onclick="setView('cooccurrence')">Shell co-occurrence</button>
  <button onclick="setView('banks')">Bank relationships</button>
  <button onclick="setView('wires')">Wire ledger</button>
  <div class="divider"></div>
  <button onclick="setView('no_wire')">❌ Missing from wires</button>
</div>

<div class="search-box">
  <input type="text" id="search" placeholder="Search entities..." oninput="searchNodes(this.value)">
</div>

<svg id="canvas"></svg>
<div class="tip" id="tip"></div>
<div class="panel" id="panel"><div id="panel-inner"></div></div>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#d4a853"></div>Shell — in wire ledger</div>
  <div class="legend-item"><div class="legend-dot" style="background:#c0504d"></div>Shell — ❌ NOT in wire ledger</div>
  <div class="legend-item"><div class="legend-dot" style="background:#5b8dbf"></div>Banking institution</div>
  <div class="legend-item"><div class="legend-dot" style="background:#6aaa6a"></div>External source / recipient</div>
  <div class="legend-item"><div class="legend-dot" style="background:#9a6abf"></div>Communication hub</div>
  <div class="legend-item"><svg width="20" height="10"><line x1="0" y1="5" x2="20" y2="5" stroke="#444" stroke-width="2"/></svg>Wire transfer / co-occurrence</div>
  <div class="legend-item"><svg width="20" height="10"><line x1="0" y1="5" x2="20" y2="5" stroke="#444" stroke-width="1" stroke-dasharray="4,3"/></svg>Banking relationship</div>
</div>

<div class="instructions">
  Drag nodes to rearrange · Scroll to zoom · Click node for details<br>
  Source: DOJ EFTA · github.com/randallscott25-star/epstein-forensic-finance
</div>

<script>
// ═══════════════════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════════════════

const nodes = [
  // Shells in wire ledger
  { id:"st", label:"Southern Trust", full:"Southern Trust Company Inc.", group:"shell_wire", files:883, fin:178, money:78569, wire:"$244M", wAmt:244 },
  { id:"sf", label:"Southern Financial", full:"Southern Financial LLC", group:"shell_wire", files:628, fin:118, money:57208, wire:"$139M", wAmt:139 },
  { id:"haze", label:"Haze Trust", full:"The Haze Trust", group:"shell_wire", files:186, fin:12, money:8486, wire:"$126M", wAmt:126 },
  { id:"jeep", label:"Jeepers", full:"Jeepers Inc.", group:"shell_wire", files:270, fin:19, money:0, wire:"$58M", wAmt:58 },
  { id:"grat", label:"Gratitude America", full:"Gratitude America Ltd.", group:"shell_wire", files:209, fin:89, money:10407, wire:"$45M", wAmt:45 },
  { id:"pland", label:"Plan D", full:"Plan D LLC", group:"shell_wire", files:55, fin:8, money:0, wire:"$41M", wAmt:41 },
  // Shells NOT in wire ledger
  { id:"ftc", label:"Financial Trust Co.", full:"Financial Trust Company", group:"shell_nowire", files:1014, fin:325, money:0, note:"Primary bank: Bear Stearns" },
  { id:"eco", label:"Epstein & Co", full:"Epstein & Co Inc.", group:"shell_nowire", files:400, fin:174, money:10482 },
  { id:"hbrk", label:"HBRK Associates", full:"HBRK Associates Inc.", group:"comms", files:13389, fin:95, money:0, emails:13146, note:"13,146 emails — operational nerve center" },
  { id:"omt", label:"Outgoing Money Trust", full:"Outgoing Money Trust", group:"shell_nowire", files:195, fin:180, money:2338, note:"Disbursement across 7 banks" },
  { id:"butt", label:"Butterfly Trust", full:"Butterfly Trust", group:"shell_nowire", files:219, fin:73, money:3302 },
  { id:"ins", label:"Insurance Trust", full:"Jeffrey E. Epstein Insurance Trust", group:"shell_nowire", files:71, fin:49, money:7800 },
  { id:"ei", label:"Epstein Interests", full:"Epstein Interests Inc.", group:"shell_nowire", files:116, fin:28, money:0 },
  { id:"naut", label:"Nautilus", full:"Nautilus Inc.", group:"shell_nowire", files:149, fin:13, money:0, note:"Aircraft operations" },
  // Banks
  { id:"bs", label:"Bear Stearns", full:"Bear Stearns", group:"bank", moneyRefs:2381211, finFiles:191, note:"#1 by money volume" },
  { id:"jpm", label:"JPMorgan Chase", full:"JPMorgan Chase", group:"bank", moneyRefs:744536, finFiles:615 },
  { id:"db", label:"Deutsche Bank", full:"Deutsche Bank", group:"bank", moneyRefs:415287, finFiles:1564, note:"$150M DFS fine → source of wire production" },
  { id:"citi", label:"Citibank", full:"Citibank", group:"bank", moneyRefs:78176, finFiles:39 },
  { id:"gs", label:"Goldman Sachs", full:"Goldman Sachs", group:"bank", moneyRefs:14999, finFiles:25 },
  { id:"hsbc", label:"HSBC", full:"HSBC", group:"bank", moneyRefs:13389, finFiles:44, note:"Bermuda connection" },
  { id:"ms", label:"Morgan Stanley", full:"Morgan Stanley", group:"bank", moneyRefs:13255, finFiles:82 },
  { id:"wf", label:"Wells Fargo", full:"Wells Fargo", group:"bank", moneyRefs:0, finFiles:153 },
  { id:"boa", label:"Bank of America", full:"Bank of America", group:"bank", moneyRefs:0, finFiles:150 },
  { id:"boh", label:"Bank of Hawaii", full:"Bank of Hawaii", group:"bank", moneyRefs:0, finFiles:734, note:"USVI — 2,431 total files" },
  // External
  { id:"black", label:"Leon Black / Apollo", full:"Leon & Debra Black / Apollo", group:"external", wire:"$60.5M" },
  { id:"roth", label:"Rothschild", full:"Benjamin Edmond de Rothschild", group:"external", wire:"$25M" },
  { id:"auction", label:"Sotheby's / Christie's", full:"Sotheby's + Christie's", group:"external", wire:"$19M" },
  { id:"tudor", label:"Tudor Futures", full:"Tudor Futures Fund", group:"external", wire:"$13.5M" },
  { id:"funds", label:"Investment Funds", full:"Boothbay · Honeycomb · Valar · Blockchain Capital", group:"external", wire:"$131M+" },
  { id:"epstein_p", label:"Epstein Personal", full:"Jeffrey Epstein NOW/SuperNow Account", group:"external", wire:"$107.3M terminal" },
];

const links = [
  // Shell co-occurrence (solid)
  { source:"sf", target:"st", type:"cooccur", weight:163, label:"163 shared files" },
  { source:"eco", target:"ftc", type:"cooccur", weight:126, label:"126 shared files" },
  { source:"ftc", target:"jeep", type:"cooccur", weight:125, label:"125 shared files" },
  { source:"hbrk", target:"st", type:"cooccur", weight:111, label:"111 shared files" },
  { source:"hbrk", target:"sf", type:"cooccur", weight:104, label:"104 shared files" },
  { source:"ftc", target:"st", type:"cooccur", weight:92, label:"92 shared files" },
  { source:"ftc", target:"sf", type:"cooccur", weight:81, label:"81 shared files" },
  { source:"eco", target:"sf", type:"cooccur", weight:73, label:"73 shared files" },
  { source:"butt", target:"st", type:"cooccur", weight:61, label:"61 shared files" },
  { source:"butt", target:"sf", type:"cooccur", weight:55, label:"55 shared files" },
  { source:"eco", target:"st", type:"cooccur", weight:51, label:"51 shared files" },
  { source:"grat", target:"st", type:"cooccur", weight:50, label:"50 shared files" },
  { source:"jeep", target:"st", type:"cooccur", weight:50, label:"50 shared files" },
  { source:"haze", target:"st", type:"cooccur", weight:49, label:"49 shared files" },
  { source:"jeep", target:"sf", type:"cooccur", weight:49, label:"49 shared files" },
  { source:"haze", target:"sf", type:"cooccur", weight:48, label:"48 shared files" },
  { source:"grat", target:"sf", type:"cooccur", weight:43, label:"43 shared files" },
  { source:"ei", target:"ftc", type:"cooccur", weight:41, label:"41 shared files" },
  { source:"butt", target:"hbrk", type:"cooccur", weight:37, label:"37 shared files" },
  { source:"hbrk", target:"haze", type:"cooccur", weight:32, label:"32 shared files" },
  { source:"naut", target:"sf", type:"cooccur", weight:32, label:"32 shared files" },
  { source:"hbrk", target:"grat", type:"cooccur", weight:30, label:"30 shared files" },
  { source:"naut", target:"st", type:"cooccur", weight:22, label:"22 shared files" },
  { source:"butt", target:"grat", type:"cooccur", weight:26, label:"26 shared files" },
  { source:"grat", target:"haze", type:"cooccur", weight:20, label:"20 shared files" },

  // Bank relationships (dashed)
  { source:"bs", target:"ftc", type:"bank", weight:66, label:"66 shared files · 6,910 money refs" },
  { source:"db", target:"omt", type:"bank", weight:180, label:"180 shared financial docs" },
  { source:"db", target:"grat", type:"bank", weight:76, label:"76 shared financial docs" },
  { source:"db", target:"butt", type:"bank", weight:55, label:"55 shared financial docs" },
  { source:"db", target:"st", type:"bank", weight:52, label:"52 shared financial docs" },
  { source:"db", target:"sf", type:"bank", weight:48, label:"48 shared financial docs" },
  { source:"db", target:"ins", type:"bank", weight:45, label:"45 shared financial docs" },
  { source:"db", target:"jeep", type:"bank", weight:10, label:"10 shared financial docs" },
  { source:"wf", target:"omt", type:"bank", weight:63, label:"63 shared financial docs" },
  { source:"boa", target:"omt", type:"bank", weight:38, label:"38 shared financial docs" },
  { source:"jpm", target:"omt", type:"bank", weight:14, label:"14 shared financial docs" },
  { source:"jpm", target:"ftc", type:"bank", weight:10, label:"10 shared financial docs" },
  { source:"hsbc", target:"haze", type:"bank", weight:5, label:"HSBC Bermuda → Haze Trust" },
  { source:"ms", target:"grat", type:"bank", weight:5, label:"Gratitude America investment vehicle" },

  // Wire transfers (solid, thick)
  { source:"black", target:"st", type:"wire", weight:60, label:"$60.5M — 6 wires, Exhibit A" },
  { source:"roth", target:"st", type:"wire", weight:25, label:"$25M — 2 wires, Exhibit A" },
  { source:"tudor", target:"sf", type:"wire", weight:13, label:"$13.5M — 1 wire, Exhibit A" },
  { source:"auction", target:"haze", type:"wire", weight:19, label:"$19M — auction proceeds, Exhibit D" },
  { source:"st", target:"sf", type:"wire", weight:67, label:"$67.9M — 8 wires, Exhibit B" },
  { source:"haze", target:"sf", type:"wire", weight:32, label:"$32M — 5 wires, Exhibit E" },
  { source:"haze", target:"st", type:"wire", weight:15, label:"$15M — 2 wires, Exhibit E" },
  { source:"jeep", target:"epstein_p", type:"wire", weight:51, label:"$51.9M — 21 wires, Exhibit C" },
  { source:"sf", target:"funds", type:"wire", weight:131, label:"$131M — investments, Exhibit B" },
  { source:"pland", target:"st", type:"wire", weight:30, label:"$30.5M — 4 wires, Exhibit B" },
];

// ═══════════════════════════════════════════════════════
// COLORS & SIZING
// ═══════════════════════════════════════════════════════

const palette = {
  shell_wire:   { fill:"#d4a853", glow:"rgba(212,168,83,0.25)", border:"rgba(212,168,83,0.5)" },
  shell_nowire: { fill:"#c0504d", glow:"rgba(192,80,77,0.25)", border:"rgba(192,80,77,0.5)" },
  bank:         { fill:"#5b8dbf", glow:"rgba(91,141,191,0.20)", border:"rgba(91,141,191,0.4)" },
  external:     { fill:"#6aaa6a", glow:"rgba(106,170,106,0.15)", border:"rgba(106,170,106,0.35)" },
  comms:        { fill:"#9a6abf", glow:"rgba(154,106,191,0.25)", border:"rgba(154,106,191,0.5)" },
};

function nodeRadius(d) {
  if (d.group === 'bank') {
    if (d.moneyRefs > 1000000) return 32;
    if (d.moneyRefs > 100000) return 24;
    if (d.moneyRefs > 10000) return 18;
    return 14;
  }
  if (d.group === 'external') return 14;
  if (d.group === 'comms') return 28;
  if (d.files > 800) return 30;
  if (d.files > 400) return 24;
  if (d.files > 200) return 20;
  if (d.files > 100) return 16;
  return 13;
}

function linkStroke(d) {
  if (d.type === 'wire') return palette.shell_wire.fill;
  if (d.type === 'bank') return palette.bank.fill;
  return 'rgba(255,255,255,0.25)';
}

function linkWidth(d) {
  const max = d.type === 'wire' ? 131 : d.type === 'bank' ? 180 : 163;
  return Math.max(0.8, (d.weight / max) * 6);
}

// ═══════════════════════════════════════════════════════
// SIMULATION
// ═══════════════════════════════════════════════════════

const W = window.innerWidth, H = window.innerHeight;
const svg = d3.select('#canvas').attr('viewBox', [0, 0, W, H]);
const tip = document.getElementById('tip');
let currentView = 'all';

// Defs for glow effects
const defs = svg.append('defs');
Object.entries(palette).forEach(([key, val]) => {
  const f = defs.append('filter').attr('id', `glow-${key}`).attr('x','-50%').attr('y','-50%').attr('width','200%').attr('height','200%');
  f.append('feGaussianBlur').attr('in','SourceGraphic').attr('stdDeviation','6').attr('result','blur');
  f.append('feFlood').attr('flood-color', val.glow).attr('result','color');
  f.append('feComposite').attr('in','color').attr('in2','blur').attr('operator','in').attr('result','shadow');
  const merge = f.append('feMerge');
  merge.append('feMergeNode').attr('in','shadow');
  merge.append('feMergeNode').attr('in','SourceGraphic');
});

const g = svg.append('g');

// Zoom
const zoom = d3.zoom().scaleExtent([0.3, 4]).on('zoom', (e) => g.attr('transform', e.transform));
svg.call(zoom);

// Initial centering
svg.call(zoom.transform, d3.zoomIdentity.translate(W/2, H/2).scale(0.85));

const simulation = d3.forceSimulation(nodes)
  .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
    if (d.type === 'wire') return 120;
    if (d.type === 'bank') return 180;
    return 100 - d.weight * 0.3;
  }).strength(d => {
    if (d.type === 'bank') return 0.15;
    return Math.min(0.5, d.weight / 200);
  }))
  .force('charge', d3.forceManyBody().strength(d => {
    if (d.group === 'bank') return -400;
    if (d.group === 'comms') return -350;
    return -250;
  }))
  .force('center', d3.forceCenter(0, 0))
  .force('collision', d3.forceCollide().radius(d => nodeRadius(d) + 12))
  .force('x', d3.forceX().strength(d => {
    if (d.group === 'bank') return 0.06;
    if (d.group === 'external') return 0.08;
    return 0.02;
  }))
  .force('y', d3.forceY().strength(0.02))
  .alphaDecay(0.015);

// Links
const linkG = g.append('g');
const linkEls = linkG.selectAll('line').data(links).join('line')
  .attr('stroke', linkStroke)
  .attr('stroke-width', linkWidth)
  .attr('stroke-opacity', d => d.type === 'bank' ? 0.25 : 0.35)
  .attr('stroke-dasharray', d => d.type === 'bank' ? '6,4' : null);

// Node groups
const nodeG = g.append('g');
const nodeEls = nodeG.selectAll('g').data(nodes).join('g')
  .attr('cursor', 'pointer')
  .call(d3.drag()
    .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
    .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
    .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
  );

// Circles
nodeEls.append('circle')
  .attr('r', nodeRadius)
  .attr('fill', d => palette[d.group]?.fill || '#888')
  .attr('fill-opacity', 0.12)
  .attr('stroke', d => palette[d.group]?.border || '#888')
  .attr('stroke-width', d => (d.id === 'st' || d.id === 'sf') ? 2 : 1)
  .attr('filter', d => `url(#glow-${d.group})`);

// Inner dot
nodeEls.append('circle')
  .attr('r', d => Math.max(3, nodeRadius(d) * 0.3))
  .attr('fill', d => palette[d.group]?.fill || '#888')
  .attr('fill-opacity', 0.7);

// Labels
nodeEls.append('text')
  .text(d => d.label)
  .attr('dy', d => nodeRadius(d) + 13)
  .attr('text-anchor', 'middle')
  .attr('font-family', 'JetBrains Mono, monospace')
  .attr('font-size', d => nodeRadius(d) > 24 ? '9px' : '8px')
  .attr('fill', d => palette[d.group]?.fill || '#888')
  .attr('fill-opacity', 0.7);

// No-wire indicator
nodeEls.filter(d => d.group === 'shell_nowire' || d.group === 'comms')
  .append('text')
  .text('❌')
  .attr('dy', -nodeRadius)
  .attr('dx', nodeRadius)
  .attr('font-size', '8px')
  .attr('text-anchor', 'middle');

// Events
nodeEls.on('mouseover', (e, d) => {
  tip.style.display = 'block';
  let h = `<strong>${d.full || d.label}</strong>`;
  if (d.files) h += `${d.files.toLocaleString()} files · ${d.fin} financial<br>`;
  if (d.money) h += `${d.money.toLocaleString()} money refs<br>`;
  if (d.emails) h += `${d.emails.toLocaleString()} emails<br>`;
  if (d.wire) h += `Wire ledger: ${d.wire}<br>`;
  if (d.moneyRefs) h += `${d.moneyRefs.toLocaleString()} money mentions<br>`;
  if (d.note) h += `<span style="color:#888">${d.note}</span>`;
  if (d.group === 'shell_nowire') h += `<span style="color:#c0504d">❌ Not in Deutsche Bank wire production</span>`;
  tip.innerHTML = h;

  // Highlight connections
  linkEls.attr('stroke-opacity', l =>
    l.source.id === d.id || l.target.id === d.id ? 0.8 : 0.06
  );
  nodeEls.select('circle:first-child').attr('fill-opacity', n =>
    n.id === d.id || links.some(l =>
      (l.source.id === d.id && l.target.id === n.id) ||
      (l.target.id === d.id && l.source.id === n.id)
    ) ? 0.2 : 0.04
  );
})
.on('mousemove', (e) => {
  tip.style.left = Math.min(e.clientX + 16, W - 320) + 'px';
  tip.style.top = (e.clientY - 10) + 'px';
})
.on('mouseout', () => {
  tip.style.display = 'none';
  applyView();
})
.on('click', (e, d) => showPanel(d));

// Tick
simulation.on('tick', () => {
  linkEls
    .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
    .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
  nodeEls.attr('transform', d => `translate(${d.x},${d.y})`);
});

// ═══════════════════════════════════════════════════════
// VIEWS
// ═══════════════════════════════════════════════════════

function setView(view) {
  currentView = view;
  document.querySelectorAll('.toolbar button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  applyView();
}

function applyView() {
  linkEls.attr('stroke-opacity', d => {
    if (currentView === 'all') return d.type === 'bank' ? 0.25 : 0.35;
    if (currentView === 'cooccurrence') return d.type === 'cooccur' ? 0.45 : 0.03;
    if (currentView === 'banks') return d.type === 'bank' ? 0.45 : 0.03;
    if (currentView === 'wires') return d.type === 'wire' ? 0.55 : 0.03;
    if (currentView === 'no_wire') {
      const s = typeof d.source === 'object' ? d.source : nodes.find(n=>n.id===d.source);
      const t = typeof d.target === 'object' ? d.target : nodes.find(n=>n.id===d.target);
      return (s?.group === 'shell_nowire' || s?.group === 'comms' || t?.group === 'shell_nowire' || t?.group === 'comms') ? 0.45 : 0.03;
    }
    return 0.35;
  });

  nodeEls.select('circle:first-child').attr('fill-opacity', d => {
    if (currentView === 'all') return 0.12;
    if (currentView === 'no_wire') return (d.group === 'shell_nowire' || d.group === 'comms') ? 0.2 : 0.04;
    if (currentView === 'banks') return d.group === 'bank' ? 0.2 : 0.06;
    if (currentView === 'wires') return (d.group === 'shell_wire' || d.group === 'external') ? 0.2 : 0.04;
    return 0.12;
  });
}

// ═══════════════════════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════════════════════

function searchNodes(q) {
  q = q.toLowerCase().trim();
  nodeEls.select('circle:first-child').attr('fill-opacity', d =>
    !q ? 0.12 : (d.label.toLowerCase().includes(q) || (d.full||'').toLowerCase().includes(q)) ? 0.35 : 0.03
  );
  nodeEls.select('text').attr('fill-opacity', d =>
    !q ? 0.7 : (d.label.toLowerCase().includes(q) || (d.full||'').toLowerCase().includes(q)) ? 1 : 0.15
  );
}

// ═══════════════════════════════════════════════════════
// DETAIL PANEL
// ═══════════════════════════════════════════════════════

function fmt(n) {
  if (!n) return '—';
  if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
  if (n >= 1e3) return Math.round(n/1e3) + 'K';
  return n.toLocaleString();
}

function showPanel(d) {
  const p = palette[d.group];
  const conns = links.filter(l => l.source.id === d.id || l.target.id === d.id);
  const maxW = Math.max(...conns.map(c => c.weight), 1);

  let h = `<div class="panel-head">
    <button class="close" onclick="closePanel()">✕</button>
    <h2>${d.full || d.label}</h2>
    <div class="badge" style="background:${p.glow};color:${p.fill};border:1px solid ${p.border}">
      ${d.group.replace('_',' ').toUpperCase()}
    </div>
  </div>`;

  h += `<div class="panel-stats">`;
  if (d.files) h += `<div class="stat-card"><div class="stat-val">${fmt(d.files)}</div><div class="stat-label">Total files</div></div>`;
  if (d.fin) h += `<div class="stat-card"><div class="stat-val">${d.fin}</div><div class="stat-label">Financial docs</div></div>`;
  if (d.money) h += `<div class="stat-card"><div class="stat-val">${fmt(d.money)}</div><div class="stat-label">Money references</div></div>`;
  if (d.emails) h += `<div class="stat-card"><div class="stat-val">${fmt(d.emails)}</div><div class="stat-label">Emails</div></div>`;
  if (d.wire) h += `<div class="stat-card"><div class="stat-val">${d.wire}</div><div class="stat-label">Wire ledger</div></div>`;
  if (d.moneyRefs) h += `<div class="stat-card"><div class="stat-val">${fmt(d.moneyRefs)}</div><div class="stat-label">Money mentions (financial docs)</div></div>`;
  if (d.finFiles) h += `<div class="stat-card"><div class="stat-val">${d.finFiles}</div><div class="stat-label">Financial files</div></div>`;
  if (d.group === 'shell_nowire') h += `<div class="stat-card" style="border-color:rgba(192,80,77,0.3)"><div class="stat-val" style="color:#c0504d">❌</div><div class="stat-label">Not in wire production</div></div>`;
  h += `</div>`;

  if (d.note) h += `<div class="panel-section"><h3>Note</h3><div style="color:#888;font-size:11px">${d.note}</div></div>`;

  if (conns.length) {
    h += `<div class="panel-section"><h3>Connections (${conns.length})</h3>`;
    conns.sort((a,b) => b.weight - a.weight).forEach(c => {
      const other = c.source.id === d.id ? c.target : c.source;
      const op = palette[other.group] || { fill:'#888' };
      const pct = Math.max(8, (c.weight / maxW) * 100);
      h += `<div class="conn-item">
        <div class="conn-dot" style="background:${op.fill}"></div>
        <div class="conn-name">${other.label}</div>
        <div class="conn-bar"><div class="conn-bar-fill" style="width:${pct}%;background:${c.type==='wire'?palette.shell_wire.fill:c.type==='bank'?palette.bank.fill:'rgba(255,255,255,0.3)'}"></div></div>
        <div class="conn-val">${c.label.split('—')[0].trim()}</div>
      </div>`;
    });
    h += `</div>`;
  }

  document.getElementById('panel-inner').innerHTML = h;
  document.getElementById('panel').classList.add('open');
}

function closePanel() { document.getElementById('panel').classList.remove('open'); }
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });
</script>
</body>
</html>
