<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Epstein Financial Shell Network — Full Architecture</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0a0c;
    color: #c8c8d0;
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .header {
    padding: 32px 48px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }

  .header h1 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 26px;
    font-weight: 600;
    color: #e8e8f0;
    letter-spacing: -0.5px;
  }

  .header .subtitle {
    font-size: 12px;
    color: #6a6a78;
    margin-top: 6px;
    line-height: 1.6;
  }

  .header .subtitle span { color: #8888a0; }

  .controls {
    padding: 12px 48px;
    display: flex;
    gap: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    flex-wrap: wrap;
    align-items: center;
  }

  .controls button {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    color: #8888a0;
    padding: 5px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 3px;
  }

  .controls button:hover, .controls button.active {
    background: rgba(255,255,255,0.08);
    color: #d0d0e0;
    border-color: rgba(255,255,255,0.15);
  }

  .controls button.active {
    border-color: rgba(200,160,100,0.4);
    color: #c8a064;
  }

  .controls .spacer { flex: 1; }

  .controls .legend {
    display: flex;
    gap: 14px;
    font-size: 9px;
    color: #5a5a68;
  }

  .controls .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .controls .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  #canvas-container {
    width: 100%;
    height: calc(100vh - 150px);
    position: relative;
    overflow: hidden;
  }

  svg { width: 100%; height: 100%; }

  .link {
    fill: none;
    stroke-opacity: 0.18;
    transition: stroke-opacity 0.3s;
    cursor: pointer;
  }

  .link:hover { stroke-opacity: 0.55; }

  .tooltip {
    position: fixed;
    background: #18181e;
    border: 1px solid rgba(255,255,255,0.1);
    padding: 12px 16px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: #c8c8d0;
    pointer-events: none;
    z-index: 100;
    max-width: 420px;
    line-height: 1.7;
    display: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }

  .tooltip .tt-name {
    font-family: 'Space Grotesk', sans-serif;
    font-weight: 600;
    font-size: 13px;
    color: #e8e8f0;
    margin-bottom: 4px;
  }

  .tooltip .tt-amount { font-size: 15px; font-weight: 500; margin-bottom: 3px; }
  .tooltip .tt-detail { color: #7a7a88; font-size: 10px; }

  .detail-panel {
    position: fixed;
    right: -440px;
    top: 0;
    width: 440px;
    height: 100vh;
    background: #111116;
    border-left: 1px solid rgba(255,255,255,0.06);
    padding: 36px 28px;
    transition: right 0.3s ease;
    z-index: 50;
    overflow-y: auto;
    font-size: 12px;
  }

  .detail-panel.open { right: 0; }

  .detail-panel .close-btn {
    position: absolute;
    top: 14px;
    right: 14px;
    background: none;
    border: none;
    color: #6a6a78;
    font-size: 18px;
    cursor: pointer;
  }

  .detail-panel h2 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 17px;
    font-weight: 600;
    color: #e8e8f0;
    margin-bottom: 4px;
  }

  .detail-panel .tier-badge {
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 2px;
    display: inline-block;
    margin-bottom: 14px;
  }

  .detail-panel .stat-row {
    display: flex;
    justify-content: space-between;
    padding: 7px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .detail-panel .stat-label { color: #6a6a78; }
  .detail-panel .stat-value { color: #d0d0e0; font-weight: 500; }

  .detail-panel .flow-section { margin-top: 16px; }

  .detail-panel .flow-section h3 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 11px;
    font-weight: 500;
    color: #8888a0;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .detail-panel .flow-item {
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .detail-panel .flow-item .flow-name { color: #a0a0b0; font-size: 10px; max-width: 240px; }
  .detail-panel .flow-item .flow-amount { color: #c8a064; font-size: 10px; font-weight: 500; }
</style>
</head>
<body>

<div class="header">
  <h1>Epstein Financial Shell Network — Full Architecture</h1>
  <div class="subtitle">
    <span>14 shell entities</span> · <span>8+ banking institutions</span> · <span>178,592 money references</span> · <span>1.48M documents</span><br>
    Source: DOJ EFTA Document Release — Full Corpus Analysis (Narrative 11)
  </div>
</div>

<div class="controls">
  <button class="active" onclick="showView('all')">All Connections</button>
  <button onclick="showView('cooccurrence')">Shell Co-Occurrence</button>
  <button onclick="showView('banks')">Bank Relationships</button>
  <button onclick="showView('wires')">Wire Ledger Only</button>
  <div class="spacer"></div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#e8c170"></div>Shell Trusts/LLCs</div>
    <div class="legend-item"><div class="legend-dot" style="background:#6aa4d0"></div>Banks</div>
    <div class="legend-item"><div class="legend-dot" style="background:#c86464"></div>External Sources</div>
    <div class="legend-item"><div class="legend-dot" style="background:#80c880"></div>Outflow Recipients</div>
  </div>
</div>

<div id="canvas-container"><svg id="network"></svg></div>
<div class="tooltip" id="tooltip"></div>
<div class="detail-panel" id="detail-panel">
  <button class="close-btn" onclick="closePanel()">✕</button>
  <div id="panel-content"></div>
</div>

<script>
// ═══ DATA ═══════════════════════════════════════════════
const nodes = [
  // SHELLS
  { id: "southern_trust", name: "Southern Trust Company Inc.", short: "Southern Trust", type: "shell", totalFiles: 883, financial: 178, money: 78569, inWireLedger: true, wireVolume: "$244M" },
  { id: "southern_fin", name: "Southern Financial LLC", short: "Southern Financial", type: "shell", totalFiles: 628, financial: 118, money: 57208, inWireLedger: true, wireVolume: "$139M" },
  { id: "financial_trust", name: "Financial Trust Company", short: "Financial Trust Co", type: "shell", totalFiles: 1014, financial: 325, money: 0, inWireLedger: false, wireVolume: "—" },
  { id: "epstein_co", name: "Epstein & Co Inc.", short: "Epstein & Co", type: "shell", totalFiles: 400, financial: 174, money: 10482, inWireLedger: false, wireVolume: "—" },
  { id: "hbrk", name: "HBRK Associates Inc.", short: "HBRK Associates", type: "shell", totalFiles: 13389, financial: 95, emails: 13146, money: 0, inWireLedger: false, wireVolume: "—" },
  { id: "gratitude", name: "Gratitude America Ltd.", short: "Gratitude America", type: "shell", totalFiles: 209, financial: 89, money: 10407, inWireLedger: true, wireVolume: "$45M" },
  { id: "haze", name: "The Haze Trust", short: "Haze Trust", type: "shell", totalFiles: 186, financial: 12, money: 8486, inWireLedger: true, wireVolume: "$126M" },
  { id: "outgoing", name: "Outgoing Money Trust", short: "Outgoing Money Trust", type: "shell", totalFiles: 195, financial: 180, money: 2338, inWireLedger: false, wireVolume: "—" },
  { id: "butterfly", name: "Butterfly Trust", short: "Butterfly Trust", type: "shell", totalFiles: 219, financial: 73, money: 3302, inWireLedger: false, wireVolume: "—" },
  { id: "insurance", name: "Jeffrey E. Epstein Insurance Trust", short: "Insurance Trust", type: "shell", totalFiles: 71, financial: 49, money: 7800, inWireLedger: false, wireVolume: "—" },
  { id: "jeepers", name: "Jeepers Inc.", short: "Jeepers", type: "shell", totalFiles: 270, financial: 19, money: 0, inWireLedger: true, wireVolume: "$58M" },
  { id: "epstein_int", name: "Epstein Interests Inc.", short: "Epstein Interests", type: "shell", totalFiles: 116, financial: 28, money: 0, inWireLedger: false, wireVolume: "—" },
  { id: "nautilus", name: "Nautilus Inc.", short: "Nautilus", type: "shell", totalFiles: 149, financial: 13, money: 0, inWireLedger: false, wireVolume: "—" },
  { id: "plan_d", name: "Plan D LLC", short: "Plan D", type: "shell", totalFiles: 55, financial: 8, money: 0, inWireLedger: true, wireVolume: "$41M" },

  // BANKS
  { id: "bear_stearns", name: "Bear Stearns / JPMorgan", short: "Bear Stearns", type: "bank", moneyMentions: 2381211, financialFiles: 191 },
  { id: "jpmorgan", name: "JPMorgan Chase", short: "JPMorgan Chase", type: "bank", moneyMentions: 744536, financialFiles: 615 },
  { id: "deutsche", name: "Deutsche Bank", short: "Deutsche Bank", type: "bank", moneyMentions: 415287, financialFiles: 1564 },
  { id: "citibank", name: "Citibank", short: "Citibank", type: "bank", moneyMentions: 78176, financialFiles: 39 },
  { id: "goldman", name: "Goldman Sachs", short: "Goldman Sachs", type: "bank", moneyMentions: 14999, financialFiles: 25 },
  { id: "hsbc", name: "HSBC", short: "HSBC", type: "bank", moneyMentions: 13389, financialFiles: 44 },
  { id: "morgan_stanley", name: "Morgan Stanley", short: "Morgan Stanley", type: "bank", moneyMentions: 13255, financialFiles: 82 },
  { id: "wells_fargo", name: "Wells Fargo", short: "Wells Fargo", type: "bank", moneyMentions: 0, financialFiles: 153 },
  { id: "boa", name: "Bank of America", short: "Bank of America", type: "bank", moneyMentions: 0, financialFiles: 150 },
  { id: "bank_hawaii", name: "Bank of Hawaii", short: "Bank of Hawaii", type: "bank", moneyMentions: 0, financialFiles: 734, note: "USVI local banking" },
  { id: "td_bank", name: "TD Bank", short: "TD Bank", type: "bank", moneyMentions: 0, financialFiles: 0 },
  { id: "fifth_third", name: "Fifth Third Bank", short: "Fifth Third Bank", type: "bank", moneyMentions: 0, financialFiles: 289 },

  // EXTERNAL SOURCES (from wire ledger)
  { id: "leon_black", name: "Leon & Debra Black / Apollo", short: "L. Black / Apollo", type: "source", wireVolume: "$60.5M" },
  { id: "rothschild", name: "Rothschild (Benjamin + Edmond)", short: "Rothschild", type: "source", wireVolume: "$25M" },
  { id: "tudor", name: "Tudor Futures Fund", short: "Tudor Futures", type: "source", wireVolume: "$13.5M" },
  { id: "sothebys", name: "Sotheby's / Christie's", short: "Sotheby's / Christie's", type: "source", wireVolume: "$19M" },

  // OUTFLOW RECIPIENTS (from wire ledger)
  { id: "boothbay", name: "Boothbay / Honeycomb / Valar", short: "Investment Funds", type: "recipient", wireVolume: "$131M" },
  { id: "ito", name: "Joichi Ito / Neoteny / Coatue", short: "Ito / Neoteny / Coatue", type: "recipient", wireVolume: "$4M" },
  { id: "melanoma", name: "Melanoma Research Alliance", short: "Melanoma Research", type: "recipient", wireVolume: "$225K" },
];

// SHELL CO-OCCURRENCE LINKS (shared document counts)
const cooccurrenceLinks = [
  { source: "southern_fin", target: "southern_trust", weight: 163, label: "163 shared files — strongest bond" },
  { source: "epstein_co", target: "financial_trust", weight: 126, label: "126 shared files — brokerage cluster" },
  { source: "financial_trust", target: "jeepers", weight: 125, label: "125 shared files — brokerage pipeline" },
  { source: "hbrk", target: "southern_trust", weight: 111, label: "111 shared files — email hub ↔ trust" },
  { source: "hbrk", target: "southern_fin", weight: 104, label: "104 shared files — email hub ↔ distribution" },
  { source: "financial_trust", target: "southern_trust", weight: 92, label: "92 shared files" },
  { source: "financial_trust", target: "southern_fin", weight: 81, label: "81 shared files" },
  { source: "epstein_co", target: "southern_fin", weight: 73, label: "73 shared files" },
  { source: "butterfly", target: "southern_trust", weight: 61, label: "61 shared files" },
  { source: "butterfly", target: "southern_fin", weight: 55, label: "55 shared files" },
  { source: "epstein_co", target: "southern_trust", weight: 51, label: "51 shared files" },
  { source: "gratitude", target: "southern_trust", weight: 50, label: "50 shared files" },
  { source: "jeepers", target: "southern_trust", weight: 50, label: "50 shared files" },
  { source: "haze", target: "southern_trust", weight: 49, label: "49 shared files" },
  { source: "jeepers", target: "southern_fin", weight: 49, label: "49 shared files" },
  { source: "haze", target: "southern_fin", weight: 48, label: "48 shared files" },
  { source: "gratitude", target: "southern_fin", weight: 43, label: "43 shared files" },
  { source: "epstein_int", target: "financial_trust", weight: 41, label: "41 shared files" },
  { source: "butterfly", target: "hbrk", weight: 37, label: "37 shared files" },
  { source: "hbrk", target: "haze", weight: 32, label: "32 shared files" },
  { source: "nautilus", target: "southern_fin", weight: 32, label: "32 shared files" },
  { source: "butterfly", target: "haze", weight: 30, label: "30 shared files" },
  { source: "epstein_co", target: "epstein_int", weight: 30, label: "30 shared files" },
  { source: "gratitude", target: "hbrk", weight: 30, label: "30 shared files" },
  { source: "butterfly", target: "gratitude", weight: 26, label: "26 shared files" },
  { source: "nautilus", target: "southern_trust", weight: 22, label: "22 shared files" },
  { source: "butterfly", target: "jeepers", weight: 21, label: "21 shared files" },
  { source: "gratitude", target: "haze", weight: 20, label: "20 shared files" },
];

// BANK-SHELL LINKS (shared financial document counts)
const bankLinks = [
  { source: "deutsche", target: "outgoing", weight: 180, label: "180 shared financial docs" },
  { source: "deutsche", target: "gratitude", weight: 76, label: "76 shared financial docs" },
  { source: "bear_stearns", target: "financial_trust", weight: 66, label: "66 shared financial docs — 6,910 money mentions" },
  { source: "wells_fargo", target: "outgoing", weight: 63, label: "63 shared financial docs" },
  { source: "deutsche", target: "butterfly", weight: 55, label: "55 shared financial docs" },
  { source: "deutsche", target: "southern_trust", weight: 52, label: "52 shared financial docs" },
  { source: "deutsche", target: "southern_fin", weight: 48, label: "48 shared financial docs" },
  { source: "deutsche", target: "insurance", weight: 45, label: "45 shared financial docs" },
  { source: "bear_stearns", target: "southern_trust", weight: 10, label: "Bear Stearns ↔ Southern Trust" },
  { source: "boa", target: "outgoing", weight: 38, label: "38 shared financial docs" },
  { source: "td_bank", target: "outgoing", weight: 23, label: "23 shared financial docs" },
  { source: "jpmorgan", target: "outgoing", weight: 14, label: "14 shared financial docs" },
  { source: "jpmorgan", target: "financial_trust", weight: 10, label: "10 shared financial docs" },
  { source: "deutsche", target: "jeepers", weight: 10, label: "10 shared financial docs" },
  { source: "hsbc", target: "haze", weight: 5, label: "HSBC Bermuda → Haze Trust" },
  { source: "morgan_stanley", target: "gratitude", weight: 5, label: "Gratitude America investment vehicle" },
  { source: "td_bank", target: "southern_fin", weight: 9, label: "9 shared financial docs" },
];

// WIRE LEDGER LINKS (verified transfers from Deutsche Bank production)
const wireLinks = [
  { source: "leon_black", target: "southern_trust", weight: 60, label: "$60.5M — 6 wires, Exhibit A" },
  { source: "rothschild", target: "southern_trust", weight: 25, label: "$25M — 2 wires, Exhibit A" },
  { source: "tudor", target: "southern_trust", weight: 13, label: "$13.5M — 1 wire, Exhibit A" },
  { source: "sothebys", target: "haze", weight: 19, label: "$19M — auction proceeds, Exhibit D" },
  { source: "southern_trust", target: "southern_fin", weight: 67, label: "$67.9M — 8 wires, Exhibit B" },
  { source: "southern_trust", target: "plan_d", weight: 30, label: "$30.5M — 4 wires, Exhibit B" },
  { source: "haze", target: "southern_fin", weight: 32, label: "$32M — 5 wires, Exhibit E" },
  { source: "haze", target: "southern_trust", weight: 15, label: "$15M — 2 wires, Exhibit E" },
  { source: "jeepers", target: "southern_trust", weight: 51, label: "$51.9M — 21 wires, Exhibit C" },
  { source: "southern_fin", target: "boothbay", weight: 131, label: "$131M — investments, Exhibit B" },
  { source: "southern_fin", target: "ito", weight: 4, label: "$4M — Ito/Neoteny/Coatue, Exhibit B" },
  { source: "gratitude", target: "melanoma", weight: 0.2, label: "$225K — rare charitable grant" },
];

// ═══ COLORS ═════════════════════════════════════════════
const typeColors = {
  shell:     { fill: "#e8c170", bg: "rgba(232,193,112,0.10)", border: "rgba(232,193,112,0.30)" },
  bank:      { fill: "#6aa4d0", bg: "rgba(106,164,208,0.10)", border: "rgba(106,164,208,0.30)" },
  source:    { fill: "#c86464", bg: "rgba(200,100,100,0.10)", border: "rgba(200,100,100,0.30)" },
  recipient: { fill: "#80c880", bg: "rgba(128,200,128,0.10)", border: "rgba(128,200,128,0.30)" },
};

// ═══ LAYOUT ENGINE ══════════════════════════════════════
const svg = document.getElementById('network');
const container = document.getElementById('canvas-container');
const tooltip = document.getElementById('tooltip');
const nodeMap = {};
nodes.forEach(n => nodeMap[n.id] = n);

let currentView = 'all';

function layout() {
  const W = container.clientWidth;
  const H = container.clientHeight;
  const cx = W / 2, cy = H / 2;

  // Shells in center cluster
  const shells = nodes.filter(n => n.type === 'shell');
  const banks = nodes.filter(n => n.type === 'bank');
  const sources = nodes.filter(n => n.type === 'source');
  const recipients = nodes.filter(n => n.type === 'recipient');

  // Core shells — force-directed approximation via fixed positions
  // Hub pair at center
  const shellPositions = {
    southern_trust:  { x: cx - 60,  y: cy - 30 },
    southern_fin:    { x: cx + 60,  y: cy - 30 },
    financial_trust: { x: cx - 180, y: cy - 100 },
    epstein_co:      { x: cx - 240, y: cy - 20 },
    hbrk:            { x: cx + 10,  y: cy + 90 },
    gratitude:       { x: cx + 180, y: cy + 60 },
    haze:            { x: cx + 200, y: cy - 80 },
    butterfly:       { x: cx + 80,  y: cy - 130 },
    insurance:       { x: cx - 120, y: cy + 80 },
    jeepers:         { x: cx - 160, y: cy + 30 },
    outgoing:        { x: cx - 50,  y: cy + 160 },
    epstein_int:     { x: cx - 280, y: cy - 100 },
    nautilus:        { x: cx + 260, y: cy + 10 },
    plan_d:          { x: cx + 280, y: cy - 40 },
  };

  shells.forEach(n => {
    const p = shellPositions[n.id] || { x: cx, y: cy };
    n.x = p.x; n.y = p.y;
    n.w = 120; n.h = 28;
  });

  // Banks — arc across top and bottom
  const bankArc = [
    { id: "bear_stearns",  x: cx - 340, y: cy - 220 },
    { id: "jpmorgan",      x: cx - 140, y: cy - 240 },
    { id: "deutsche",      x: cx + 60,  y: cy - 250 },
    { id: "citibank",      x: cx + 240, y: cy - 220 },
    { id: "goldman",       x: cx + 360, y: cy - 160 },
    { id: "hsbc",          x: cx + 360, y: cy + 100 },
    { id: "morgan_stanley", x: cx + 340, y: cy + 170 },
    { id: "wells_fargo",   x: cx - 200, y: cy + 220 },
    { id: "boa",           x: cx - 50,  y: cy + 250 },
    { id: "bank_hawaii",   x: cx + 140, y: cy + 230 },
    { id: "td_bank",       x: cx + 80,  y: cy + 180 },
    { id: "fifth_third",   x: cx - 340, y: cy + 140 },
  ];

  bankArc.forEach(p => {
    const n = nodeMap[p.id];
    if (n) { n.x = p.x; n.y = p.y; n.w = 110; n.h = 24; }
  });

  // Sources — far left
  sources.forEach((n, i) => {
    n.x = 40; n.y = cy - 120 + i * 60;
    n.w = 120; n.h = 26;
  });

  // Recipients — far right
  recipients.forEach((n, i) => {
    n.x = W - 160; n.y = cy - 60 + i * 60;
    n.w = 120; n.h = 26;
  });
}

function render() {
  const W = container.clientWidth;
  const H = container.clientHeight;
  svg.innerHTML = '';
  layout();

  // Determine visible links
  let visibleLinks = [];
  if (currentView === 'all') {
    visibleLinks = [...cooccurrenceLinks, ...bankLinks, ...wireLinks];
  } else if (currentView === 'cooccurrence') {
    visibleLinks = cooccurrenceLinks;
  } else if (currentView === 'banks') {
    visibleLinks = bankLinks;
  } else if (currentView === 'wires') {
    visibleLinks = wireLinks;
  }

  const maxWeight = Math.max(...visibleLinks.map(l => l.weight), 1);

  // Draw links
  visibleLinks.forEach(link => {
    const s = nodeMap[link.source];
    const t = nodeMap[link.target];
    if (!s || !t) return;

    const thickness = Math.max(1, (link.weight / maxWeight) * 12);
    const sx = s.x + s.w / 2, sy = s.y + s.h / 2;
    const tx = t.x + t.w / 2, ty = t.y + t.h / 2;
    const dx = tx - sx, dy = ty - sy;
    const dist = Math.sqrt(dx * dx + dy * dy);
    const cp = dist * 0.3;

    // Curve perpendicular to the line
    const nx = -dy / dist * cp * 0.3;
    const ny = dx / dist * cp * 0.3;
    const mx = (sx + tx) / 2 + nx;
    const my = (sy + ty) / 2 + ny;

    let color = s.type === 'bank' || t.type === 'bank' ? typeColors.bank.fill :
                s.type === 'source' || t.type === 'source' ? typeColors.source.fill :
                s.type === 'recipient' || t.type === 'recipient' ? typeColors.recipient.fill :
                typeColors.shell.fill;

    const path = createSVG('path', {
      d: `M${sx},${sy} Q${mx},${my} ${tx},${ty}`,
      class: 'link',
      stroke: color,
      'stroke-width': thickness,
    });

    path.addEventListener('mouseenter', (e) => {
      tooltip.innerHTML = `<div class="tt-name">${s.short} ↔ ${t.short}</div><div class="tt-detail">${link.label}</div>`;
      tooltip.style.display = 'block';
    });
    path.addEventListener('mouseleave', () => tooltip.style.display = 'none');
    path.addEventListener('mousemove', positionTooltip);
    svg.appendChild(path);
  });

  // Determine visible nodes
  let visibleNodeIds = new Set();
  if (currentView === 'all') {
    nodes.forEach(n => visibleNodeIds.add(n.id));
  } else {
    visibleLinks.forEach(l => { visibleNodeIds.add(l.source); visibleNodeIds.add(l.target); });
  }

  // Draw nodes
  nodes.forEach(node => {
    if (!visibleNodeIds.has(node.id)) return;
    const colors = typeColors[node.type];
    const g = createSVG('g', { transform: `translate(${node.x},${node.y})`, style: 'cursor:pointer' });

    const rect = createSVG('rect', {
      width: node.w, height: node.h, rx: 3,
      fill: colors.bg, stroke: colors.border, 'stroke-width': 1
    });

    const text = createSVG('text', {
      x: node.w / 2, y: node.h / 2 + 1,
      'text-anchor': 'middle', 'dominant-baseline': 'middle',
      'font-family': 'DM Mono, monospace',
      'font-size': node.type === 'bank' ? '8px' : '9px',
      fill: colors.fill
    });
    text.textContent = node.short;

    // Not-in-wire-ledger indicator for shells
    if (node.type === 'shell' && node.inWireLedger === false) {
      const badge = createSVG('rect', {
        x: node.w - 8, y: -4, width: 8, height: 8, rx: 1,
        fill: 'rgba(200,100,100,0.6)', stroke: '#0a0a0c', 'stroke-width': 1
      });
      g.appendChild(badge);
    }

    g.appendChild(rect);
    g.appendChild(text);

    g.addEventListener('mouseenter', (e) => showNodeTooltip(e, node));
    g.addEventListener('mouseleave', () => tooltip.style.display = 'none');
    g.addEventListener('mousemove', positionTooltip);
    g.addEventListener('click', () => showNodeDetail(node));
    svg.appendChild(g);
  });
}

// ═══ HELPERS ════════════════════════════════════════════
function createSVG(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  Object.entries(attrs).forEach(([k, v]) => el.setAttribute(k, v));
  return el;
}

function fmt(n) {
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(0) + 'K';
  return n.toLocaleString();
}

function positionTooltip(e) {
  tooltip.style.left = Math.min(e.clientX + 14, window.innerWidth - 440) + 'px';
  tooltip.style.top = Math.min(e.clientY - 10, window.innerHeight - 100) + 'px';
}

function showNodeTooltip(e, node) {
  let html = `<div class="tt-name">${node.name}</div>`;
  if (node.type === 'shell') {
    html += `<div class="tt-amount" style="color:${typeColors.shell.fill}">${node.totalFiles.toLocaleString()} files · ${node.financial} financial</div>`;
    if (node.money) html += `<div class="tt-detail">${fmt(node.money)} money mentions</div>`;
    if (node.emails) html += `<div class="tt-detail">${fmt(node.emails)} emails</div>`;
    html += `<div class="tt-detail">Wire ledger: ${node.inWireLedger ? node.wireVolume : '❌ Not in production'}</div>`;
  } else if (node.type === 'bank') {
    html += `<div class="tt-amount" style="color:${typeColors.bank.fill}">${fmt(node.moneyMentions || 0)} money mentions</div>`;
    html += `<div class="tt-detail">${node.financialFiles} financial files</div>`;
    if (node.note) html += `<div class="tt-detail">${node.note}</div>`;
  } else {
    html += `<div class="tt-detail">${node.wireVolume || ''}</div>`;
  }
  html += `<div class="tt-detail" style="margin-top:4px">Click for details</div>`;
  tooltip.innerHTML = html;
  tooltip.style.display = 'block';
}

function showNodeDetail(node) {
  const panel = document.getElementById('detail-panel');
  const content = document.getElementById('panel-content');
  const colors = typeColors[node.type];

  let html = `<h2>${node.name}</h2>`;
  html += `<div class="tier-badge" style="background:${colors.bg};color:${colors.fill};border:1px solid ${colors.border}">${node.type.toUpperCase()}</div>`;

  if (node.type === 'shell') {
    html += `<div class="stat-row"><span class="stat-label">Total files</span><span class="stat-value">${node.totalFiles.toLocaleString()}</span></div>`;
    html += `<div class="stat-row"><span class="stat-label">Financial docs</span><span class="stat-value">${node.financial}</span></div>`;
    if (node.money) html += `<div class="stat-row"><span class="stat-label">Money mentions</span><span class="stat-value">${fmt(node.money)}</span></div>`;
    if (node.emails) html += `<div class="stat-row"><span class="stat-label">Emails</span><span class="stat-value">${fmt(node.emails)}</span></div>`;
    html += `<div class="stat-row"><span class="stat-label">Wire ledger</span><span class="stat-value">${node.inWireLedger ? node.wireVolume : '❌ Not in production'}</span></div>`;
  } else if (node.type === 'bank') {
    html += `<div class="stat-row"><span class="stat-label">Money mentions</span><span class="stat-value">${fmt(node.moneyMentions || 0)}</span></div>`;
    html += `<div class="stat-row"><span class="stat-label">Financial files</span><span class="stat-value">${node.financialFiles}</span></div>`;
    if (node.note) html += `<div class="stat-row"><span class="stat-label">Note</span><span class="stat-value">${node.note}</span></div>`;
  }

  // Connected entities
  const allLinks = [...cooccurrenceLinks, ...bankLinks, ...wireLinks];
  const connections = allLinks.filter(l => l.source === node.id || l.target === node.id);
  if (connections.length > 0) {
    html += `<div class="flow-section"><h3>Connections (${connections.length})</h3>`;
    connections.sort((a, b) => b.weight - a.weight).forEach(l => {
      const otherId = l.source === node.id ? l.target : l.source;
      const other = nodeMap[otherId];
      html += `<div class="flow-item">
        <span class="flow-name">${other ? other.short : otherId}</span>
        <span class="flow-amount">${l.label}</span>
      </div>`;
    });
    html += `</div>`;
  }

  content.innerHTML = html;
  panel.classList.add('open');
}

function closePanel() { document.getElementById('detail-panel').classList.remove('open'); }

function showView(view) {
  currentView = view;
  document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  render();
}

// ═══ INIT ═══════════════════════════════════════════════
render();
window.addEventListener('resize', render);
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });
</script>
</body>
</html>
