<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Epstein Financial Shell Network — Fund Flow Architecture</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0a0c;
    color: #c8c8d0;
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .header {
    padding: 40px 60px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }

  .header h1 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 28px;
    font-weight: 600;
    color: #e8e8f0;
    letter-spacing: -0.5px;
  }

  .header .subtitle {
    font-size: 13px;
    color: #6a6a78;
    margin-top: 8px;
    line-height: 1.6;
  }

  .header .subtitle span {
    color: #8888a0;
  }

  .controls {
    padding: 16px 60px;
    display: flex;
    gap: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    flex-wrap: wrap;
    align-items: center;
  }

  .controls button {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    color: #8888a0;
    padding: 6px 14px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 3px;
  }

  .controls button:hover, .controls button.active {
    background: rgba(255,255,255,0.08);
    color: #d0d0e0;
    border-color: rgba(255,255,255,0.15);
  }

  .controls button.active {
    border-color: rgba(200,160,100,0.4);
    color: #c8a064;
  }

  .controls .spacer { flex: 1; }

  .controls .legend {
    display: flex;
    gap: 16px;
    font-size: 10px;
    color: #5a5a68;
  }

  .controls .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .controls .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  #canvas-container {
    width: 100%;
    height: calc(100vh - 180px);
    position: relative;
    overflow: hidden;
  }

  svg {
    width: 100%;
    height: 100%;
  }

  .node rect {
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .node text {
    font-family: 'DM Mono', monospace;
    fill: #b0b0c0;
    pointer-events: none;
  }

  .link {
    fill: none;
    stroke-opacity: 0.25;
    transition: stroke-opacity 0.3s;
  }

  .link:hover {
    stroke-opacity: 0.6;
  }

  .tooltip {
    position: fixed;
    background: #18181e;
    border: 1px solid rgba(255,255,255,0.1);
    padding: 14px 18px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: #c8c8d0;
    pointer-events: none;
    z-index: 100;
    max-width: 380px;
    line-height: 1.7;
    display: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }

  .tooltip .tt-name {
    font-family: 'Space Grotesk', sans-serif;
    font-weight: 600;
    font-size: 13px;
    color: #e8e8f0;
    margin-bottom: 6px;
  }

  .tooltip .tt-amount {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 4px;
  }

  .tooltip .tt-detail {
    color: #7a7a88;
    font-size: 10px;
  }

  .tier-label {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    fill: #3a3a48;
  }

  .tier-line {
    stroke: rgba(255,255,255,0.03);
    stroke-dasharray: 4 4;
  }

  .detail-panel {
    position: fixed;
    right: -420px;
    top: 0;
    width: 420px;
    height: 100vh;
    background: #111116;
    border-left: 1px solid rgba(255,255,255,0.06);
    padding: 40px 30px;
    transition: right 0.3s ease;
    z-index: 50;
    overflow-y: auto;
    font-size: 12px;
  }

  .detail-panel.open {
    right: 0;
  }

  .detail-panel .close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    color: #6a6a78;
    font-size: 18px;
    cursor: pointer;
  }

  .detail-panel h2 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: #e8e8f0;
    margin-bottom: 4px;
  }

  .detail-panel .tier-badge {
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 2px;
    display: inline-block;
    margin-bottom: 16px;
  }

  .detail-panel .stat-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .detail-panel .stat-label { color: #6a6a78; }
  .detail-panel .stat-value { color: #d0d0e0; font-weight: 500; }

  .detail-panel .flow-section {
    margin-top: 20px;
  }

  .detail-panel .flow-section h3 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: #8888a0;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .detail-panel .flow-item {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .detail-panel .flow-item .flow-name {
    color: #a0a0b0;
    font-size: 11px;
    max-width: 220px;
  }

  .detail-panel .flow-item .flow-amount {
    color: #c8a064;
    font-size: 11px;
    font-weight: 500;
  }
</style>
</head>
<body>

<div class="header">
  <h1>Epstein Financial Shell Network</h1>
  <div class="subtitle">
    <span>382 verified wire transfers</span> · $1.964 billion · <span>4-tier shell architecture</span><br>
    Source: DOJ EFTA Document Release — Deutsche Bank-SDNY Production (Exhibits A–E)
  </div>
</div>

<div class="controls">
  <button class="active" onclick="showAll()">All Flows</button>
  <button onclick="highlightExhibit('A')">Exhibit A — Inflows</button>
  <button onclick="highlightExhibit('B')">Exhibit B — Investments</button>
  <button onclick="highlightExhibit('C')">Exhibit C — Jeepers</button>
  <button onclick="highlightExhibit('D')">Exhibit D — Disbursements</button>
  <button onclick="highlightExhibit('E')">Exhibit E — Deutsche Bank</button>
  <div class="spacer"></div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#c86464"></div>External Sources</div>
    <div class="legend-item"><div class="legend-dot" style="background:#c8a064"></div>Shell Trusts</div>
    <div class="legend-item"><div class="legend-dot" style="background:#64a0c8"></div>Operating Accounts</div>
    <div class="legend-item"><div class="legend-dot" style="background:#80c880"></div>Outflow Recipients</div>
  </div>
</div>

<div id="canvas-container">
  <svg id="network"></svg>
</div>

<div class="tooltip" id="tooltip"></div>

<div class="detail-panel" id="detail-panel">
  <button class="close-btn" onclick="closePanel()">✕</button>
  <div id="panel-content"></div>
</div>

<script>
// ─── DATA ─────────────────────────────────────────────────
const nodes = [
  // TIER 0: External Sources (left)
  { id: "leon_black", name: "Leon & Debra Black", short: "L. Black", tier: 0, type: "source", totalOut: 60500000 },
  { id: "narrow", name: "Narrow Holdings LLC", short: "Narrow Holdings", tier: 0, type: "source", totalOut: 20000000 },
  { id: "rothschild_b", name: "Benjamin de Rothschild", short: "B. Rothschild", tier: 0, type: "source", totalOut: 14999980 },
  { id: "rothschild_e", name: "Edmond de Rothschild (Suisse)", short: "E. Rothschild", tier: 0, type: "source", totalOut: 10000000 },
  { id: "tudor", name: "Tudor Futures Fund", short: "Tudor Futures", tier: 0, type: "source", totalOut: 13503941 },
  { id: "kellerhals", name: "Kellerhals Ferguson Kroblin", short: "Kellerhals", tier: 0, type: "source", totalOut: 23075000 },
  { id: "sothebys", name: "Sotheby's", short: "Sotheby's", tier: 0, type: "source", totalOut: 11249417 },
  { id: "christies", name: "Christie's Inc.", short: "Christie's", tier: 0, type: "source", totalOut: 7725000 },
  { id: "bly", name: "Adam Bly / Seed Media", short: "A. Bly", tier: 0, type: "source", totalOut: 315468 },

  // TIER 1: Shell Trusts (accumulation/distribution)
  { id: "southern_trust", name: "Southern Trust Company Inc.", short: "Southern Trust", tier: 1, type: "shell", totalFlow: 244299980, victimDocs: 12 },
  { id: "southern_fin", name: "Southern Financial LLC", short: "Southern Financial", tier: 1, type: "shell", totalFlow: 139244568, victimDocs: 37 },
  { id: "haze", name: "The Haze Trust", short: "Haze Trust", tier: 1, type: "shell", totalFlow: 126391673, victimDocs: 0 },
  { id: "gratitude", name: "Gratitude America Ltd.", short: "Gratitude America", tier: 1, type: "shell", totalFlow: 45083245, victimDocs: 6 },

  // TIER 2: Operating Accounts (transit)
  { id: "epstein_now", name: "Epstein NOW/SuperNow Account", short: "Epstein NOW", tier: 2, type: "operating", totalFlow: 107323684 },
  { id: "jeepers", name: "Jeepers Inc. (Brokerage)", short: "Jeepers Brokerage", tier: 2, type: "operating", totalFlow: 57876640 },
  { id: "bv70", name: "BV70 LLC", short: "BV70", tier: 2, type: "operating", totalFlow: 60500000 },
  { id: "plan_d", name: "Plan D LLC", short: "Plan D", tier: 2, type: "operating", totalFlow: 40500000 },

  // TIER 3: Outflow Recipients (right)
  { id: "boothbay", name: "Boothbay Fund Complex", short: "Boothbay", tier: 3, type: "recipient", totalIn: 38250000 },
  { id: "honeycomb", name: "Honeycomb Partners LP", short: "Honeycomb", tier: 3, type: "recipient", totalIn: 64000000 },
  { id: "valar", name: "Valar Global Funds", short: "Valar Global", tier: 3, type: "recipient", totalIn: 28800000 },
  { id: "caterpillar", name: "The 2017 Caterpillar Trust", short: "Caterpillar Trust", tier: 3, type: "recipient", totalIn: 15000000 },
  { id: "ito", name: "Joichi Ito / Neoteny", short: "Ito / Neoteny", tier: 3, type: "recipient", totalIn: 2030000 },
  { id: "coatue", name: "Coatue Enterprises LLC", short: "Coatue", tier: 3, type: "recipient", totalIn: 2000000 },
  { id: "melanoma", name: "Melanoma Research Alliance", short: "Melanoma Research", tier: 3, type: "recipient", totalIn: 225000 },
  { id: "blockchain", name: "Blockchain Capital Funds", short: "Blockchain Capital", tier: 3, type: "recipient", totalIn: 15000000 },
];

const links = [
  // External Sources → Shell Trusts
  { source: "leon_black", target: "southern_trust", amount: 60500000, wires: 6, exhibit: "A", label: "$60.5M via Apollo + direct" },
  { source: "narrow", target: "southern_trust", amount: 20000000, wires: 1, exhibit: "A", label: "$20M c/o Elysium Management" },
  { source: "rothschild_b", target: "southern_trust", amount: 14999980, wires: 1, exhibit: "A", label: "$15M single wire" },
  { source: "rothschild_e", target: "southern_trust", amount: 10000000, wires: 1, exhibit: "A", label: "$10M from Swiss account" },
  { source: "tudor", target: "southern_trust", amount: 13503941, wires: 1, exhibit: "A", label: "$13.5M — only non-round Exhibit A" },
  { source: "kellerhals", target: "epstein_now", amount: 23075000, wires: 2, exhibit: "C", label: "$23M V.I. legal fees" },
  { source: "sothebys", target: "haze", amount: 11249417, wires: 1, exhibit: "E", label: "Art auction proceeds" },
  { source: "christies", target: "haze", amount: 7725000, wires: 1, exhibit: "E", label: "Art auction proceeds" },
  { source: "bly", target: "epstein_now", amount: 315468, wires: 8, exhibit: "C", label: "$315K across 8 small wires" },

  // Shell Trusts → Operating Accounts
  { source: "southern_trust", target: "epstein_now", amount: 10000000, wires: 1, exhibit: "A", label: "Trust → personal checking" },
  { source: "southern_trust", target: "plan_d", amount: 30500000, wires: 4, exhibit: "B", label: "$30.5M to Leon Black vehicle" },
  { source: "southern_trust", target: "southern_fin", amount: 67855320, wires: 8, exhibit: "B", label: "Trust → Financial LLC" },
  { source: "haze", target: "southern_fin", amount: 32000000, wires: 5, exhibit: "E", label: "Art money → distribution" },
  { source: "haze", target: "southern_trust", amount: 15000000, wires: 2, exhibit: "E", label: "Cross-trust transfer" },

  // Operating Accounts — internal
  { source: "jeepers", target: "epstein_now", amount: 51876640, wires: 21, exhibit: "C", label: "Brokerage ATM — 21 wires" },
  { source: "jeepers", target: "bv70", amount: 6000000, wires: 3, exhibit: "C", label: "Brokerage → BV70" },
  { source: "epstein_now", target: "gratitude", amount: 12768369, wires: 24, exhibit: "D", label: "Personal → 'charity'" },

  // Shell Trusts / Operating → Outflow
  { source: "southern_fin", target: "boothbay", amount: 38250000, wires: 6, exhibit: "B", label: "Investment fund allocation" },
  { source: "southern_fin", target: "honeycomb", amount: 53000000, wires: 5, exhibit: "B", label: "Investment fund allocation" },
  { source: "southern_fin", target: "valar", amount: 28800000, wires: 4, exhibit: "B", label: "Peter Thiel-linked fund" },
  { source: "southern_fin", target: "caterpillar", amount: 15000000, wires: 2, exhibit: "B", label: "Trust disbursement" },
  { source: "southern_fin", target: "ito", amount: 2030000, wires: 3, exhibit: "B", label: "MIT Media Lab director" },
  { source: "southern_fin", target: "coatue", amount: 2000000, wires: 4, exhibit: "B", label: "Tech investment fund" },
  { source: "southern_fin", target: "blockchain", amount: 15000000, wires: 3, exhibit: "B", label: "Crypto venture funds" },
  { source: "gratitude", target: "melanoma", amount: 225000, wires: 3, exhibit: "D", label: "Rare actual charitable grant" },
  { source: "plan_d", target: "leon_black", amount: 18000000, wires: 3, exhibit: "B", label: "$18M back to Black — net flow question" },
  { source: "gratitude", target: "honeycomb", amount: 11000000, wires: 2, exhibit: "D", label: "'Charity' → investment fund" },
];

// ─── COLOR SCHEME ──────────────────────────────────────────
const tierColors = {
  source: { fill: "#c86464", bg: "rgba(200,100,100,0.12)", border: "rgba(200,100,100,0.3)", text: "#c86464" },
  shell: { fill: "#c8a064", bg: "rgba(200,160,100,0.12)", border: "rgba(200,160,100,0.3)", text: "#c8a064" },
  operating: { fill: "#64a0c8", bg: "rgba(100,160,200,0.12)", border: "rgba(100,160,200,0.3)", text: "#64a0c8" },
  recipient: { fill: "#80c880", bg: "rgba(128,200,128,0.12)", border: "rgba(128,200,128,0.3)", text: "#80c880" }
};

const tierLabels = ["EXTERNAL SOURCES", "SHELL TRUSTS", "OPERATING ACCOUNTS", "OUTFLOW RECIPIENTS"];

// ─── LAYOUT ────────────────────────────────────────────────
const svg = document.getElementById('network');
const container = document.getElementById('canvas-container');
const tooltip = document.getElementById('tooltip');

function render() {
  const W = container.clientWidth;
  const H = container.clientHeight;
  svg.innerHTML = '';

  const margin = { top: 50, right: 60, bottom: 30, left: 60 };
  const innerW = W - margin.left - margin.right;
  const innerH = H - margin.top - margin.bottom;

  // Tier x-positions
  const tierX = [0, 0.3, 0.6, 0.9].map(t => margin.left + t * innerW);

  // Group nodes by tier
  const tiers = [[], [], [], []];
  nodes.forEach(n => tiers[n.tier].push(n));

  // Position nodes
  const nodeHeight = 32;
  const nodeWidth = 140;
  tiers.forEach((tierNodes, ti) => {
    const totalH = tierNodes.length * (nodeHeight + 12);
    const startY = margin.top + (innerH - totalH) / 2;
    tierNodes.forEach((n, ni) => {
      n.x = tierX[ti];
      n.y = startY + ni * (nodeHeight + 12);
      n.w = nodeWidth;
      n.h = nodeHeight;
    });
  });

  // Create node lookup
  const nodeMap = {};
  nodes.forEach(n => nodeMap[n.id] = n);

  // ─── Draw tier labels and dividers
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  svg.appendChild(defs);

  tierLabels.forEach((label, i) => {
    const x = tierX[i] + nodeWidth / 2;
    const text = createSVG('text', { x, y: margin.top - 20, 'text-anchor': 'middle', class: 'tier-label' });
    text.textContent = label;
    svg.appendChild(text);
  });

  // ─── Draw links
  const maxAmount = Math.max(...links.map(l => l.amount));

  links.forEach(link => {
    const s = nodeMap[link.source];
    const t = nodeMap[link.target];
    if (!s || !t) return;

    const thickness = Math.max(1.5, (link.amount / maxAmount) * 18);
    const x1 = s.x + s.w;
    const y1 = s.y + s.h / 2;
    const x2 = t.x;
    const y2 = t.y + t.h / 2;

    // Handle left-to-right and same-tier links
    const dx = x2 - x1;
    const cp = Math.max(Math.abs(dx) * 0.5, 60);

    const path = createSVG('path', {
      d: `M${x1},${y1} C${x1 + cp},${y1} ${x2 - cp},${y2} ${x2},${y2}`,
      class: 'link',
      stroke: tierColors[s.type].fill,
      'stroke-width': thickness,
      'data-exhibit': link.exhibit,
      'data-source': link.source,
      'data-target': link.target
    });

    path.addEventListener('mouseenter', (e) => showLinkTooltip(e, link, s, t));
    path.addEventListener('mouseleave', hideTooltip);
    path.addEventListener('click', () => showLinkDetail(link, s, t));
    svg.appendChild(path);
  });

  // ─── Draw nodes
  nodes.forEach(node => {
    const colors = tierColors[node.type];
    const g = createSVG('g', { class: 'node', transform: `translate(${node.x},${node.y})` });

    const rect = createSVG('rect', {
      width: node.w, height: node.h, rx: 3,
      fill: colors.bg, stroke: colors.border, 'stroke-width': 1
    });

    const text = createSVG('text', {
      x: node.w / 2, y: node.h / 2 + 1,
      'text-anchor': 'middle', 'dominant-baseline': 'middle',
      'font-size': '10px', fill: colors.text
    });
    text.textContent = node.short;

    // Victim doc badge for shells
    if (node.victimDocs > 0) {
      const badge = createSVG('circle', {
        cx: node.w - 4, cy: 4, r: 7,
        fill: '#c86464', stroke: '#0a0a0c', 'stroke-width': 2
      });
      const badgeText = createSVG('text', {
        x: node.w - 4, y: 5, 'text-anchor': 'middle', 'dominant-baseline': 'middle',
        'font-size': '7px', fill: '#fff', 'font-weight': '600'
      });
      badgeText.textContent = node.victimDocs;
      g.appendChild(badge);
      g.appendChild(badgeText);
    }

    g.appendChild(rect);
    g.appendChild(text);

    g.addEventListener('mouseenter', (e) => showNodeTooltip(e, node));
    g.addEventListener('mouseleave', hideTooltip);
    g.addEventListener('click', () => showNodeDetail(node));

    svg.appendChild(g);
  });
}

// ─── SVG HELPERS ───────────────────────────────────────────
function createSVG(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  Object.entries(attrs).forEach(([k, v]) => el.setAttribute(k, v));
  return el;
}

function fmt(n) {
  if (n >= 1e9) return '$' + (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return '$' + (n / 1e3).toFixed(0) + 'K';
  return '$' + n.toLocaleString();
}

// ─── TOOLTIPS ──────────────────────────────────────────────
function showNodeTooltip(e, node) {
  const amount = node.totalOut || node.totalFlow || node.totalIn || 0;
  let html = `<div class="tt-name">${node.name}</div>`;
  html += `<div class="tt-amount" style="color:${tierColors[node.type].text}">${fmt(amount)}</div>`;
  if (node.victimDocs) html += `<div class="tt-detail" style="color:#c86464">⚠ ${node.victimDocs} victim-related documents</div>`;
  html += `<div class="tt-detail">Click for details</div>`;
  tooltip.innerHTML = html;
  tooltip.style.display = 'block';
  positionTooltip(e);
}

function showLinkTooltip(e, link, s, t) {
  let html = `<div class="tt-name">${s.short} → ${t.short}</div>`;
  html += `<div class="tt-amount" style="color:${tierColors[s.type].text}">${fmt(link.amount)}</div>`;
  html += `<div class="tt-detail">${link.wires} wire${link.wires > 1 ? 's' : ''} · Exhibit ${link.exhibit}</div>`;
  html += `<div class="tt-detail">${link.label}</div>`;
  tooltip.innerHTML = html;
  tooltip.style.display = 'block';
  positionTooltip(e);
}

function positionTooltip(e) {
  const x = e.clientX + 16;
  const y = e.clientY - 10;
  tooltip.style.left = Math.min(x, window.innerWidth - 400) + 'px';
  tooltip.style.top = Math.min(y, window.innerHeight - 120) + 'px';
}

function hideTooltip() {
  tooltip.style.display = 'none';
}

document.addEventListener('mousemove', (e) => {
  if (tooltip.style.display === 'block') positionTooltip(e);
});

// ─── DETAIL PANEL ──────────────────────────────────────────
function showNodeDetail(node) {
  const panel = document.getElementById('detail-panel');
  const content = document.getElementById('panel-content');
  const colors = tierColors[node.type];

  const inflows = links.filter(l => l.target === node.id);
  const outflows = links.filter(l => l.source === node.id);

  let html = `<h2>${node.name}</h2>`;
  html += `<div class="tier-badge" style="background:${colors.bg};color:${colors.text};border:1px solid ${colors.border}">${tierLabels[node.tier]}</div>`;

  if (node.victimDocs) {
    html += `<div style="background:rgba(200,100,100,0.1);border:1px solid rgba(200,100,100,0.2);padding:10px;margin-bottom:16px;font-size:11px;color:#c86464">
      ⚠ This entity appears in ${node.victimDocs} victim-related court filings in the EFTA corpus</div>`;
  }

  const amount = node.totalOut || node.totalFlow || node.totalIn || 0;
  html += `<div class="stat-row"><span class="stat-label">Total volume</span><span class="stat-value">${fmt(amount)}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">Inbound connections</span><span class="stat-value">${inflows.length}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">Outbound connections</span><span class="stat-value">${outflows.length}</span></div>`;

  if (inflows.length > 0) {
    html += `<div class="flow-section"><h3>Inflows</h3>`;
    inflows.sort((a, b) => b.amount - a.amount).forEach(l => {
      const src = nodes.find(n => n.id === l.source);
      html += `<div class="flow-item">
        <span class="flow-name">${src ? src.short : l.source}<br><span style="color:#5a5a68;font-size:9px">${l.wires} wire${l.wires > 1 ? 's' : ''} · Ex. ${l.exhibit}</span></span>
        <span class="flow-amount">${fmt(l.amount)}</span>
      </div>`;
    });
    html += `</div>`;
  }

  if (outflows.length > 0) {
    html += `<div class="flow-section"><h3>Outflows</h3>`;
    outflows.sort((a, b) => b.amount - a.amount).forEach(l => {
      const tgt = nodes.find(n => n.id === l.target);
      html += `<div class="flow-item">
        <span class="flow-name">${tgt ? tgt.short : l.target}<br><span style="color:#5a5a68;font-size:9px">${l.wires} wire${l.wires > 1 ? 's' : ''} · Ex. ${l.exhibit}</span></span>
        <span class="flow-amount">${fmt(l.amount)}</span>
      </div>`;
    });
    html += `</div>`;
  }

  content.innerHTML = html;
  panel.classList.add('open');
}

function showLinkDetail(link, s, t) {
  const panel = document.getElementById('detail-panel');
  const content = document.getElementById('panel-content');

  let html = `<h2>${s.short} → ${t.short}</h2>`;
  html += `<div class="tier-badge" style="background:rgba(255,255,255,0.05);color:#8888a0;border:1px solid rgba(255,255,255,0.1)">EXHIBIT ${link.exhibit}</div>`;
  html += `<div class="stat-row"><span class="stat-label">Total amount</span><span class="stat-value" style="color:#c8a064">${fmt(link.amount)}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">Wire count</span><span class="stat-value">${link.wires}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">Exhibit</span><span class="stat-value">${link.exhibit}</span></div>`;
  html += `<div style="margin-top:16px;padding:12px;background:rgba(255,255,255,0.03);font-size:11px;color:#8888a0;line-height:1.7">${link.label}</div>`;

  content.innerHTML = html;
  panel.classList.add('open');
}

function closePanel() {
  document.getElementById('detail-panel').classList.remove('open');
}

// ─── EXHIBIT FILTER ────────────────────────────────────────
function highlightExhibit(exhibit) {
  document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.link').forEach(link => {
    link.style.strokeOpacity = link.dataset.exhibit === exhibit ? '0.6' : '0.05';
  });
}

function showAll() {
  document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.link').forEach(link => {
    link.style.strokeOpacity = '0.25';
  });
}

// ─── INIT ──────────────────────────────────────────────────
render();
window.addEventListener('resize', render);

// Close panel on escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closePanel();
});
</script>
</body>
</html>
